<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Issuer front-end</title>
    <script
      language="javascript"
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    ></script>
    <script src="https://unpkg.com/@metamask/legacy-web3@latest/dist/metamask.web3.min.js"></script>
    <script
      language="javascript"
      type="text/javascript"
      src="web3.min.js"
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="AcademicCredentials_abi.js"
    ></script>
    <script src="AcademicCredentialsAddress.js"></script>
  </head>
  <body>
    <!-- <div id="txStatus">Hello</div>
    <div id="credentials"></div>
    <input type="text" id="employeeName" />
    <button
      onclick="createRandomZombie(document.getElementById('employeeName').value)"
    >
      Get Credentials for user
    </button> -->

    <script>
      function handleSubmit() {
        const name = document.getElementById("name").value;
        const dateOfIssue = document.getElementById("dateOfIssue").value;
        const expirationDate = document.getElementById("expirationDate").value;
        const description = document.getElementById("description").value;
        const credentialUrl = document.getElementById("credentialUrl").value;
        const credentialType = document.getElementById("credentialType").value;

        createCredential(
          name,
          dateToBigInt(dateOfIssue),
          dateToBigInt(expirationDate),
          description,
          credentialUrl,
          credentialType
        );
      }
    </script>

    <div className="app">
      <h1>Create Credential</h1>
      <form id="credentialForm">
        <label>
          Name:
          <input type="text" id="name" />
        </label>
        <label>
          Date of Issue:
          <input type="date" id="dateOfIssue" />
        </label>
        <label>
          Expiration Date:
          <input type="date" id="expirationDate" />
        </label>
        <label>
          Description:
          <input type="text" id="description" />
        </label>
        <label>
          Credential URL:
          <input type="text" id="credentialUrl" />
        </label>
        <label>
          Credential Type:
          <select id="credentialType">
            <option value="0">Certificate</option>
            <option value="1">Degree</option>
            <option value="2">Achievement</option>
          </select>
        </label>
        <button type="submit">Create Credential</button>
      </form>
      <button
        onclick="getCredentialsByIssuer(userAccount).then(displayCredentials)"
      >
        Get Credentials
      </button>
      <div>
        <div id="txStatus"></div>
        <div id="credentials"></div>
      </div>
      <div>
        <ul id="owners"></ul>
      </div>
    </div>

    <script>
      var credentials;
      var userAccount;
      var ownersAccounts;

      document
        .getElementById("credentialForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent form submission
          handleSubmit(); // Call the handleSubmit function
        });

      function transfer(account) {
        $("#txStatus").text(
          "Vezi ca dureaza seful meu transferul asta greu ca pumnul meu!"
        );
        credentials.methods
          .transferFrom(userAccount, account, 0)
          .send({ from: userAccount })
          .on("receipt", function (receipt) {
            $("#txStatus").text(
              "Successfully transferred credential to " + account + "!"
            );
            // getCredentialsByIssuer(userAccount).then(displayCredentials);
          })
          .on("error", function (error) {
            $("#txStatus").text(error);
          });
      }

      async function startApp() {
        var credentialAddress = CREDENTIAL_ADDRESS;
        credentials = new web3js.eth.Contract(
          AcademicCredentialABI,
          credentialAddress
        );

        if (window.ethereum) {
          await ethereum.enable();
        }

        function getAccounts(callback) {
          web3.eth.getAccounts((error, result) => {
            if (error) {
              console.log(error);
            } else {
              callback(result);
            }
          });
        }

        getAccounts(function (result) {
          userAccount = result[0];
          ownersAccounts = result.slice(1);
          for (const account of ownersAccounts) {
            $("#owners").append(
              `<li>Owner: ${account} <button onclick="transfer('${account}')">Transfer</button></li>`
            );
          }
          getCredentialsByIssuer(userAccount).then(displayCredentials);
        });

        // Listen for account changes using MetaMask
        window.ethereum.on("accountsChanged", function (accounts) {
          userAccount = accounts[0]; // Update the user's account
          console.log("User Account changed:", userAccount);
          // Call a function to update the UI with the new account
          getCredentialsByIssuer(userAccount).then(displayCredentials);
        });

        credentials.events
          .NewCredential({ filter: { issuer: userAccount } })
          .on("data", function (event) {
            let data = event.returnValues;
            getCredentialsByIssuer(userAccount).then(displayCredentials);
          })
          .on("error", console.error);

        credentials.events
          .Transfer({ filter: { _from: userAccount } })
          .on("data", function (event) {
            let data = event.returnValues;
            // The current user just received a zombie!
            getCredentialsByIssuer(userAccount).then(displayCredentials);
          })
          .on("error", console.error);
      }

      function dateToBigInt(date) {
        return Math.floor(new Date(date).getTime() / 1000);
      }

      async function createCredential(
        name,
        dateOfIssue,
        expirationDate,
        description,
        credentialUrl,
        credentialType
      ) {
        $("#txStatus").text(
          "Creating new credential on the blockchain. This may take a while..."
        );

        console.log(
          name,
          dateOfIssue,
          expirationDate,
          description,
          credentialUrl,
          credentialType
        );
        return credentials.methods
          .createCredential(
            name,
            credentialType,
            dateOfIssue,
            expirationDate,
            description,
            credentialUrl
          )
          .send({ from: userAccount })
          .on("receipt", function (receipt) {
            $("#txStatus").text("Successfully created " + name + "!");
            // Transaction was accepted into the blockchain, let's redraw the UI
            getCredentialsByIssuer(userAccount).then(displayCredentials);
          })
          .on("error", function (error) {
            // Do something to alert the user their transaction has failed
            $("#txStatus").text(error);
          });
      }

      function intToDate(timestamp) {
        return new Date(timestamp * 1000).toISOString().split("T")[0];
      }

      function typeToString(type) {
        switch (type) {
          case "0":
            return "Certificate";
          case "1":
            return "Degree";
          case "2":
            return "Achievement";
          default:
            return "Unknown";
        }
      }

      function displayCredentials(ids) {
        console.log(ids);
        $("#credentials").empty();
        for (const id of ids) {
          // Look up credential details from our contract. Returns a `credential` object
          getCredentialDetails(id).then(function (credential) {
            // Using ES6's "template literals" to inject variables into the HTML.
            // Append each one to our #credentials div
            $("#credentials").append(`<div class="credential">
							<ul>
								<li>Name: ${credential.name}</li>
								<li>Date of Issue: ${intToDate(credential.dateIssued)}</li>
								<li>Expiration Date: ${intToDate(credential.expirationDate)}</li>
								<li>Description: ${credential.description}</li>
								<li>Credential URL: <a href="${
                  credential.credentialUrl
                }">${credential.credentialUrl}</a></li>
								<li>Credential Type: ${typeToString(credential.credentialType)}</li>
							</ul>
							</div>`);
          });
        }
      }

      function getCredentialDetails(id) {
        return credentials.methods.credentials(id).call();
      }

      function getCredentialsByIssuer(owner) {
        return credentials.methods.getCredentialsByIssuer(owner).call();
      }

      window.addEventListener("load", function () {
        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== "undefined") {
          // Use Mist/MetaMask's provider
          web3js = new Web3(web3.currentProvider);
        } else {
          // Handle the case where the user doesn't have Metamask installed
          // Probably show them a message prompting them to install Metamask
          console.log("No web3? You should consider trying MetaMask!");
        }

        // Now you can start your app & access web3 freely:
        startApp();
      });
    </script>
  </body>
</html>
