<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Issuer front-end</title>
    <script
      language="javascript"
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    ></script>
    <script src="https://unpkg.com/@metamask/legacy-web3@latest/dist/metamask.web3.min.js"></script>
    <script
      language="javascript"
      type="text/javascript"
      src="web3.min.js"
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="AcademicCredentials_abi.js"
    ></script>
    <script src="AcademicCredentialsAddress.js"></script>
    <script src="utils.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="page center-content-flex">
      <div class="navigation">
        <div class="title">
          <h1><a href="index.html" id="home">Academic Credentials</a></h1>
          <h2>Issuer</h2>
        </div>
        <button class="create-credential-btn" onclick="handleShowForm()">
          Create Credential
        </button>
        <div id="credentials"></div>
        <div>
          <ul id="owners"></ul>
        </div>
      </div>
      <div class="content center-content-flex">
        <form
          id="credentialForm"
          class="creade-credential-form general-form center-content-flex"
        >
          <label>
            Name:
            <input type="text" id="name" placeholder="John Dawn" required />
          </label>
          <label>
            Date of Issue:
            <input type="date" id="dateOfIssue" required />
          </label>
          <label>
            Expiration Date:
            <input type="date" id="expirationDate" required />
          </label>
          <label>
            Description:
            <input
              type="text"
              id="description"
              placeholder="Computer Science, Literature"
              required
            />
          </label>
          <label>
            Credential URL:
            <input
              type="text"
              id="credentialUrl"
              placeholder="www.example.com"
              required
            />
          </label>
          <label>
            Credential Type:
            <div class="credential-types">
              <div class="credential-type cursor-pointer">
                <input
                  type="radio"
                  id="Certificate"
                  value="0"
                  name="credentialType"
                  class="cursor-pointer"
                  checked
                />
                <label for="Certificate" class="cursor-pointer"
                  >Certificate</label
                >
              </div>
              <div class="credential-type cursor-pointer">
                <input
                  type="radio"
                  id="Degree"
                  value="1"
                  name="credentialType"
                  class="cursor-pointer"
                />
                <label for="Degree" class="cursor-pointer">Degree</label>
              </div>
              <div class="credential-type cursor-pointer">
                <input
                  type="radio"
                  id="Achievement"
                  value="2"
                  name="credentialType"
                  class="cursor-pointer"
                />
                <label for="Achievement" class="cursor-pointer"
                  >Achievement</label
                >
              </div>
            </div>
          </label>
          <button
            type="submit"
            class="form-submit-btn create-credential-btn center-content-flex"
          >
            Create Credential
          </button>
        </form>
        <div id="txStatus"></div>
      </div>

      <!-- <button
        onclick="getCredentialsByIssuer(userAccount).then(displayCredentials)"
      >
        Get Credentials
      </button> -->
    </div>

    <script>
      userType = "issuer";

      function handleShowForm() {
        document.getElementById("credentialForm").classList.toggle("show");
      }

      function handleSubmit() {
        const name = document.getElementById("name").value;
        const dateOfIssue = document.getElementById("dateOfIssue").value;
        const expirationDate = document.getElementById("expirationDate").value;
        const description = document.getElementById("description").value;
        const credentialUrl = document.getElementById("credentialUrl").value;
        const credentialType = document.querySelector(
          'input[name="credentialType"]:checked'
        ).value;

        createCredential(
          name,
          dateToBigInt(dateOfIssue),
          dateToBigInt(expirationDate),
          description,
          credentialUrl,
          credentialType
        );
      }
      var ownersAccounts;

      document
        .getElementById("credentialForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          handleSubmit();
        });

      document.getElementById("expirationDate").min = new Date()
        .toISOString()
        .split("T")[0];

      function transfer(account) {
        $("#txStatus").text(
          "Vezi ca dureaza seful meu transferul asta greu ca pumnul meu!"
        );
        credentials.methods
          .transferFrom(userAccount, account, 0)
          .send({ from: userAccount })
          .on("receipt", function (receipt) {
            $("#txStatus").text(
              "Successfully transferred credential to " + account + "!"
            );
            // getCredentialsByIssuer(userAccount).then(displayCredentials);
          })
          .on("error", function (error) {
            $("#txStatus").text(error);
          });
      }

      function dateToBigInt(date) {
        return Math.floor(new Date(date).getTime() / 1000);
      }

      async function createCredential(
        name,
        dateOfIssue,
        expirationDate,
        description,
        credentialUrl,
        credentialType
      ) {
        $("#txStatus").text(
          "Creating new credential on the blockchain. This may take a while..."
        );

        console.log(
          name,
          dateOfIssue,
          expirationDate,
          description,
          credentialUrl,
          credentialType
        );
        return credentials.methods
          .createCredential(
            name,
            credentialType,
            dateOfIssue,
            expirationDate,
            description,
            credentialUrl
          )
          .send({ from: userAccount })
          .on("receipt", function (receipt) {
            $("#txStatus").text("Successfully created " + name + "!");
            getCredentialsByIssuer(userAccount).then(displayCredentials);
          })
          .on("error", function (error) {
            $("#txStatus").text(error);
          });
      }

      function getCredentialsByIssuer(owner) {
        return credentials.methods.getCredentialsByIssuer(owner).call();
      }

      loadApp();
    </script>
  </body>
</html>
